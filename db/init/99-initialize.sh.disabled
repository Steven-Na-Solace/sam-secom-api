#!/bin/bash
# ============================================================================
# SECOM MES Database Initialization - Option C (Hybrid)
# Main orchestration script for complete database setup
# ============================================================================

set -e  # Exit on any error

echo "============================================================================"
echo "SECOM MES Database Initialization - Option C"
echo "============================================================================"
echo ""

# Check if Python is installed, install if not
echo "Step 1: Checking Python installation..."
if ! command -v python3 &> /dev/null; then
    echo "  ðŸ“¦ Python not found. Installing Python 3 and pymysql..."
    apt-get update -qq
    apt-get install -y -qq python3 python3-pip > /dev/null 2>&1
    pip3 install --quiet pymysql
    echo "  âœ“ Python 3 and pymysql installed"
else
    echo "  âœ“ Python 3 already installed"
    # Ensure pymysql is installed
    pip3 install --quiet pymysql 2>/dev/null || true
fi
echo ""

# Generate feature metadata SQL
echo "Step 2: Generating feature metadata..."
python3 /docker-entrypoint-initdb.d/25-feature-meta-generator.py > /docker-entrypoint-initdb.d/25-feature-meta.sql
echo "  âœ“ Feature metadata SQL generated (590 features)"
echo ""

# Execute SQL scripts in order
echo "Step 3: Creating database schema..."
mariadb -u root -p"${MARIADB_ROOT_PASSWORD}" secom < /docker-entrypoint-initdb.d/10-schema.sql
echo "  âœ“ Schema created (9 tables + 4 views)"
echo ""

echo "Step 4: Loading master data..."
mariadb -u root -p"${MARIADB_ROOT_PASSWORD}" secom < /docker-entrypoint-initdb.d/20-master-data.sql
echo "  âœ“ Master data loaded (8 equipment, 3 shifts, 15 operators, 4 products)"
echo ""

echo "Step 5: Loading feature metadata..."
mariadb -u root -p"${MARIADB_ROOT_PASSWORD}" secom < /docker-entrypoint-initdb.d/25-feature-meta.sql
echo "  âœ“ Feature metadata loaded (590 features)"
echo ""

echo "Step 6: Loading production data (this may take 2-3 minutes)..."
python3 /docker-entrypoint-initdb.d/30-load-production-data.py
echo "  âœ“ Production data loaded"
echo ""

echo "Step 7: Calculating feature importance..."
mariadb -u root -p"${MARIADB_ROOT_PASSWORD}" secom < /docker-entrypoint-initdb.d/35-calculate-analytics.sql
echo "  âœ“ Analytics calculated"
echo ""

# Final verification
echo "============================================================================"
echo "FINAL VERIFICATION"
echo "============================================================================"

mariadb -u root -p"${MARIADB_ROOT_PASSWORD}" secom <<'SQL'
SELECT 'âœ“ Database: secom' as status;

SELECT CONCAT('âœ“ Tables: ', COUNT(*), ' created') as status
FROM information_schema.tables
WHERE table_schema = 'secom' AND table_type = 'BASE TABLE';

SELECT CONCAT('âœ“ Views: ', COUNT(*), ' created') as status
FROM information_schema.tables
WHERE table_schema = 'secom' AND table_type = 'VIEW';

SELECT 'âœ“ Production Summary:' as status;
SELECT * FROM production_summary;

SELECT 'âœ“ Equipment Health:' as status;
SELECT equipment_code, total_lots_processed, failed_lots, equipment_fail_rate_pct, health_score
FROM equipment_health_stats
ORDER BY equipment_code;

SELECT 'âœ“ Shift Performance:' as status;
SELECT shift_name, total_lots, fail_count, fail_rate_pct
FROM shift_performance_comparison
ORDER BY shift_id;
SQL

echo ""
echo "============================================================================"
echo "âœ… SECOM MES DATABASE INITIALIZATION COMPLETE!"
echo "============================================================================"
echo ""
echo "Database is ready for use:"
echo "  â€¢ 9 core tables + 4 analytics views"
echo "  â€¢ 1,567 production lots"
echo "  â€¢ ~700K+ sensor measurements"
echo "  â€¢ AI/ML risk predictions included"
echo "  â€¢ Feature importance calculated"
echo ""
echo "Connect using:"
echo "  docker exec -it secom-db mariadb -u secom_user -psecom_pass secom"
echo ""
echo "============================================================================"
